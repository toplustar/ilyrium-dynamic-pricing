# Solana RPC Rate Limiting

## The Issue

You're seeing these errors in the logs:

```
Server responded with 429 Too Many Requests. Retrying after 500ms delay...
```

**Why?** The free public Solana RPC endpoint has very strict rate limits and your bot is hitting them when monitoring for payments.

## Where It's Coming From

The 429 errors are generated by the **@solana/web3.js** library (not your code) when it calls:

```typescript
// In SolanaService.parseTransaction()
await this.connection.getParsedTransaction(signatureInfo.signature, ...)
```

The library automatically retries with exponential backoff (500ms, 1000ms, 2000ms, 4000ms).

## Solutions

### Option 1: Use a Premium RPC Provider (RECOMMENDED)

Free public RPCs are not suitable for production. Use a dedicated provider:

#### **QuickNode** (Recommended)
- Free tier: 50 requests/second
- Sign up: https://www.quicknode.com/
- After signup, update `.env`:

```env
SOLANA_RPC_URL=https://your-project.solana-mainnet.quiknode.pro/xxxxx/
```

#### **Helius**
- Free tier: 100 requests/day
- Sign up: https://helius.dev/
- Update `.env`:

```env
SOLANA_RPC_URL=https://mainnet.helius-rpc.com/?api-key=your-key
```

#### **Alchemy**
- Free tier available
- Sign up: https://www.alchemy.com/
- Update `.env`:

```env
SOLANA_RPC_URL=https://solana-mainnet.g.alchemy.com/v2/your-key
```

### Option 2: Reduce Polling Frequency

If you want to continue using the free public RPC, increase the polling interval:

**Current:** Checks every 10 seconds
**Recommended:** Check every 30-60 seconds

Update `.env`:
```env
# Check every 30 seconds instead of 10
PAYMENT_POLL_INTERVAL=30000

# Or every 60 seconds
PAYMENT_POLL_INTERVAL=60000
```

**Impact:** Payments will be detected 20-50 seconds later, but rate limit errors will be reduced.

### Option 3: Reduce Transaction Query Limit

The code has been updated to only query the last 10 transactions instead of 100:

```typescript
// Already implemented in SolanaService
async queryTransactionsByMemo(memo: string, limit = 10): Promise<SolanaTransaction[]>
```

This reduces API calls by 90%.

### Option 4: Add Delays Between Requests

The code now includes a 100ms delay between parsing each transaction:

```typescript
// Already implemented in SolanaService
await new Promise(resolve => setTimeout(resolve, 100));
```

This helps avoid hitting rate limits when processing multiple transactions.

## Current Implementation

Your code now has these optimizations:

âœ… Query limit reduced from 100 to 10 transactions
âœ… 100ms delay between parsing transactions
âœ… Transaction monitor checks every 10 seconds (configurable)

## Recommended Production Setup

For production, use this configuration:

```env
# Use a premium RPC provider
SOLANA_RPC_URL=https://your-quicknode-url.quiknode.pro/xxxxx/

# Poll every 15-20 seconds (good balance)
PAYMENT_POLL_INTERVAL=15000

# Mainnet USDC
SOLANA_USDC_MINT=EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v

# Your wallet
SOLANA_PAYMENT_WALLET=YourWalletAddressHere

# Standard confirmation count
SOLANA_CONFIRMATION_COUNT=32
```

## For Testing (Devnet)

If you're testing on Solana Devnet:

```env
# Devnet RPC (free, less rate limiting than mainnet)
SOLANA_RPC_URL=https://api.devnet.solana.com

# Devnet USDC
SOLANA_USDC_MINT=4zMMC9srt5Ri5X14GAgXhaHii3GnPAEERYPJgZJDncDU

# Your devnet wallet
SOLANA_PAYMENT_WALLET=YourDevnetWalletAddress

# Can poll more frequently on devnet
PAYMENT_POLL_INTERVAL=10000
```

## Rate Limit Comparison

| Provider | Free Tier | Cost |
|----------|-----------|------|
| Public RPC | ~5 req/sec | Free |
| QuickNode | 50 req/sec | Free/$9/mo |
| Helius | 100 req/day | Free/$29/mo |
| Alchemy | Varies | Free/$49/mo |

## Monitoring Rate Limits

To see if you're hitting rate limits, check the logs:

```bash
# Look for 429 errors
npm run start:dev 2>&1 | grep "429"

# Look for Solana warnings
npm run start:dev 2>&1 | grep "SolanaService"
```

## Summary

**Quick Fix (2 minutes):**
1. Update `PAYMENT_POLL_INTERVAL=30000` in `.env`
2. Restart the app

**Production Fix (5 minutes):**
1. Sign up for QuickNode (free)
2. Update `SOLANA_RPC_URL` with your endpoint
3. Keep `PAYMENT_POLL_INTERVAL=10000` (or 15000)
4. Enjoy unlimited monitoring! ðŸš€

---

**Generated:** 2025-10-12
**Issue:** 429 Rate Limit Errors
**Status:** Mitigated with code optimizations, fully fixable with premium RPC
